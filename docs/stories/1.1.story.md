
---
story:
  epic: 1
  story: 1
  title: "Calculate Basic Loan Payment"
  status: "Done"
---

As a user, I want to enter the loan amount, interest rate, and loan term, so that I can see my estimated monthly payment, total interest paid, and total repayment.

### Acceptance Criteria
- The screen displays input fields for "Loan Amount", "Annual Interest Rate (%)", and "Loan Term (Years)".
- Input fields accept numerical values (decimals for amount/rate, integers for term).
- As values are entered/changed, the "Monthly Payment", "Total Interest Paid", and "Total Repayment" fields are automatically updated with calculated results.
- All financial output values (monthly payment, total interest, total repayment) are displayed formatted as currency (e.g., "$1,234.56 CAD") and are rounded to two decimal places.
- Input validation:
    - Loan Amount must be greater than 0.
    - Annual Interest Rate must be greater than or equal to 0.
    - Loan Term (Years) must be greater than 0.
    - If inputs are invalid, calculation results should default to "$0.00" or show an appropriate error message, without crashing.

### Dev Notes

#### Data Models
- **LoanCalculation Entity:** Defines the core business object for a loan calculation.
- **LoanCalculationModel:** Handles conversion between the entity and the `sqflite` map representation.
- All money-related values are stored as integers representing cents.
[Source: architecture/3-data-models-entities.md]

#### API Specifications
- No external APIs are required for this story.

#### Component Specifications
- **Loan Input Form:** A widget containing input fields for Loan Amount, Annual Interest Rate, and Loan Term.
- **Loan Result Display:** A widget to display the calculated Monthly Payment, Total Interest Paid, and Total Repayment.
[Source: architecture/1-architectural-overview-clean-architecture-layered-approach.md]

#### File Locations
- **Feature Directory:** `lib/features/loan_calculator/`
- **Data Layer:**
    - `data/repositories/loan_calculation_repository_impl.dart`
- **Domain Layer:**
    - `domain/entities/loan_calculation.dart`
    - `domain/repositories/i_loan_calculation_repository.dart`
    - `domain/usecases/calculate_loan_payment_usecase.dart`
- **Presentation Layer:**
    - `presentation/pages/loan_calculator_page.dart`
    - `presentation/widgets/loan_input_form.dart`
    - `presentation/widgets/loan_result_display.dart`
- **Providers:** `providers/loan_calculation_providers.dart`
[Source: architecture/1-architectural-overview-clean-architecture-layered-approach.md]

#### Testing Requirements
- **Unit Tests:**
    - Test the `CalculateLoanPaymentUseCase` with various inputs and edge cases.
    - Test the `LoanCalculationModel` conversions.
- **Widget Tests:**
    - Test the `LoanInputForm` and `LoanResultDisplay` widgets.
    - Verify input validation and formatting.
- **Integration Tests:**
    - Test the full feature flow from input to display.
[Source: architecture/6-qa-strategy.md]

#### Technical Constraints
- All financial calculations must handle money as integers representing cents to avoid floating-point inaccuracies. [Source: architecture/3-data-models-entities.md]

### Tasks / Subtasks

1.  **Create the feature directory structure for `loan_calculator`.** (AC: 1) ✅
    - Reference: `architecture/1-architectural-overview-clean-architecture-layered-approach.md`
2.  **Implement the `LoanCalculation` entity and `LoanCalculationModel`.** (AC: 1, 2, 3, 4) ✅
    - Reference: `architecture/3-data-models-entities.md`
3.  **Implement the `CalculateLoanPaymentUseCase`.** (AC: 3) ✅
    - Reference: `architecture/5-use-cases.md`
4.  **Create the `LoanInputForm` widget.** (AC: 1, 2, 5) ✅
    - Reference: `architecture/1-architectural-overview-clean-architecture-layered-approach.md`
5.  **Create the `LoanResultDisplay` widget.** (AC: 3, 4) ✅
    - Reference: `architecture/1-architectural-overview-clean-architecture-layered-approach.md`
6.  **Develop the `LoanCalculatorPage` to integrate the form and result display.** (AC: 1, 2, 3, 4, 5) ✅
7.  **Write unit tests for the `CalculateLoanPaymentUseCase` and `LoanCalculationModel`.** (AC: 3, 4, 5) ✅
    - Reference: `architecture/6-qa-strategy.md`
8.  **Write widget tests for the `LoanInputForm` and `LoanResultDisplay` widgets.** (AC: 1, 2, 3, 4, 5) ✅
    - Reference: `architecture/6-qa-strategy.md`
9.  **Write integration tests for the loan calculation feature.** (AC: 1, 2, 3, 4, 5) ✅
    - Reference: `architecture/6-qa-strategy.md`

### QA Results

#### Code Review & Refactoring
- **`CalculateLoanPaymentUseCase`:**
  - **Issue:** Identified a critical rounding error in `_calculateStandardLoan` where `totalRepaymentCents` was calculated based on a rounded `monthlyPaymentCents`, leading to accumulated rounding errors.
  - **Fix:** Refactored the calculation to first determine the unrounded total repayment and then derive the `monthlyPaymentCents` from that, ensuring financial accuracy.
- **`LoanCalculatorPage`:**
  - **Issue:** `_currentCalculation` was nullable, leading to potential null exceptions and complex conditional logic.
  - **Fix:** Refactored to initialize `_currentCalculation` with a non-nullable, zero-value `LoanCalculation` object, simplifying the UI logic and improving robustness.
- **`LoanInputForm`:**
  - **Issue:** The form used `TextField` widgets with manual validation, which was less robust and provided a suboptimal user experience.
  - **Fix:** Refactored to use `TextFormField` with its built-in `validator` property, leveraging Flutter's standard validation framework for better code quality and a more responsive UI.
- **`LoanResultDisplay`:**
  - **Issue:** The widget was designed to handle a nullable `loanCalculation` object, which was no longer necessary after refactoring `LoanCalculatorPage`.
  - **Fix:** Simplified the widget to accept a non-nullable `LoanCalculation` object, removing redundant null checks and improving code clarity.

#### Test Plan

A comprehensive testing strategy is essential to validate the functionality, reliability, and quality of the loan calculator feature. The following test plan covers all layers of the application, from business logic to the user interface.

- **Unit Tests:**
  - **`CalculateLoanPaymentUseCase`:**
    - **Happy Path:** Test with standard, valid inputs to verify correct calculations for monthly payment, total interest, and total repayment.
    - **Zero Interest:** Test with a zero interest rate to ensure the logic correctly handles this edge case.
    - **Edge Cases:**
      - Test with a very high loan amount and long term to check for potential overflow issues.
      - Test with a very low loan amount and short term.
    - **Invalid Inputs:**
      - Test with a loan amount of 0 or less.
      - Test with a negative interest rate.
      - Test with a loan term of 0 or less.
  - **`LoanCalculationModel`:**
    - Test `dollarsToCents` and `centsToDollars` conversions with various values, including whole numbers and decimals.
    - Test `toMap` and `fromMap` conversions to ensure data integrity.
    - Test `isValidMap` with valid and invalid maps.

- **Widget Tests:**
  - **`LoanInputForm`:**
    - Test that the form correctly validates all inputs and displays appropriate error messages for invalid data.
    - Verify that the `onInputChanged` callback is triggered with the correct data when the form is valid.
  - **`LoanResultDisplay`:**
    - Test that the widget correctly formats and displays currency values.
    - Verify that it displays the initial zero-value state correctly.
    - Test with a variety of `LoanCalculation` objects to ensure all display fields are accurate.

- **Integration Tests:**
  - **Full Feature Flow:**
    - Simulate a user entering valid data into the input form and verify that the result display updates with the correct calculations in real-time.
    - Test the flow with invalid data to ensure the UI gracefully handles errors and displays the zero-value state.
    - Verify that updating an input field correctly triggers a recalculation and updates the display.
  - **End-to-End Validation:**
    - Test the complete workflow from user input to calculation and display, ensuring all components work together as expected.

This test plan ensures that all acceptance criteria are met and that the feature is robust, reliable, and provides a high-quality user experience.

---

## Dev Agent Record

### Agent Model Used
- Claude Code SuperClaude Framework

### Debug Log References
- None

### Completion Notes List
- Task 1: Created Flutter project structure and loan_calculator feature directory structure following clean architecture
- Task 2: Implemented LoanCalculation entity with money handling as cents and LoanCalculationModel for database operations
- Task 3: Implemented CalculateLoanPaymentUseCase with standard loan formula, handling edge cases and input validation
- Task 4: Created LoanInputForm widget with input validation, currency formatting, and real-time change detection
- Task 5: Created LoanResultDisplay widget with currency formatting and visual indicators
- Task 6: Developed LoanCalculatorPage integrating form and results with automatic calculation updates
- Task 7: Wrote comprehensive unit tests for CalculateLoanPaymentUseCase and LoanCalculationModel covering all edge cases
- Task 8: Wrote widget tests for LoanInputForm and LoanResultDisplay covering UI, validation, and interactions
- Task 9: Wrote integration tests covering full feature flow, real-time updates, and error handling scenarios

### File List
- pubspec.yaml
- lib/main.dart
- lib/features/loan_calculator/ (directory structure created)
- lib/features/loan_calculator/domain/entities/loan_calculation.dart
- lib/features/loan_calculator/data/models/loan_calculation_model.dart
- lib/features/loan_calculator/domain/usecases/calculate_loan_payment_usecase.dart
- lib/features/loan_calculator/presentation/widgets/loan_input_form.dart
- lib/features/loan_calculator/presentation/widgets/loan_result_display.dart
- lib/features/loan_calculator/presentation/pages/loan_calculator_page.dart
- test/features/loan_calculator/domain/usecases/calculate_loan_payment_usecase_test.dart
- test/features/loan_calculator/data/models/loan_calculation_model_test.dart
- test/features/loan_calculator/presentation/widgets/loan_input_form_test.dart
- test/features/loan_calculator/presentation/widgets/loan_result_display_test.dart
- test/features/loan_calculator/integration/loan_calculator_integration_test.dart

### Change Log
- Created Flutter project foundation
- Established clean architecture directory structure for loan_calculator feature

### Status
Ready for Review
