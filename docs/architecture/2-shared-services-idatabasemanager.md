# 2. Shared Services: `IDatabaseManager`

A central service for `sqflite` operations is critical for managing database connections, centralizing schema management, and enhancing testability by providing an injectable interface.

## `lib/core/services/i_database_manager.dart`

```dart
import 'package:sqflite/sqflite.dart';

abstract class IDatabaseManager {
  Future<Database> get database;
  Future<void> close(); // For proper resource management
}
````

## `lib/core/services/sqflite_manager.dart` (Concrete Implementation)

```dart
import 'package:sqflite/sqflite.dart';
import 'package:path/path.dart';
import 'package:personal_finance_calculator/core/services/i_database_manager.dart';

class SqfLiteManager implements IDatabaseManager {
  static final SqfLiteManager _instance = SqfLiteManager._internal();
  static Database? _database;

  factory SqfLiteManager() {
    return _instance;
  }

  SqfLiteManager._internal();

  @override
  Future<Database> get database async {
    if (_database != null) return _database!;
    _database = await _initDb();
    return _database!;
  }

  Future<Database> _initDb() async {
    final dbPath = await getDatabasesPath();
    final path = join(dbPath, 'personal_finance_app.db');

    return await openDatabase(
      path,
      version: 1,
      onCreate: _onCreate,
      onUpgrade: _onUpgrade,
    );
  }

  Future<void> _onCreate(Database db, int version) async {
    await db.execute('''
      CREATE TABLE loan_calculations(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        loanAmount INTEGER NOT NULL,          -- Stored in cents
        interestRate REAL NOT NULL,
        loanTermYears INTEGER NOT NULL,
        monthlyPayment INTEGER NOT NULL,      -- Stored in cents
        totalInterestPaid INTEGER NOT NULL,   -- Stored in cents
        totalRepayment INTEGER NOT NULL,      -- Stored in cents
        savedAt TEXT NOT NULL
      )
    ''');

    await db.execute('''
      CREATE TABLE investment_calculations(
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        initialInvestment INTEGER NOT NULL,   -- Stored in cents
        regularContribution INTEGER NOT NULL, -- Stored in cents
        contributionFrequency TEXT NOT NULL,
        interestRate REAL NOT NULL,
        investmentPeriodYears INTEGER NOT NULL,
        estimatedFutureValue INTEGER NOT NULL,-- Stored in cents
        totalContributions INTEGER NOT NULL,  -- Stored in cents
        totalEarnings INTEGER NOT NULL,       -- Stored in cents
        savedAt TEXT NOT NULL
      )
    ''');
  }

  Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
    // Implement schema migration logic here for future versions if DB schema changes.
    // Example: if (oldVersion < 2) { await db.execute("ALTER TABLE some_table ADD COLUMN new_column TEXT;"); }
  }

  @override
  Future<void> close() async {
    final db = await database;
    await db.close();
    _database = null;
  }
}
```

## `lib/core/providers/database_providers.dart` (Riverpod Setup)

Global Riverpod providers to make the database manager and instance available throughout the application using dependency injection.

```dart
import 'package:riverpod_annotation/riverpod_annotation.dart';
import 'package:sqflite/sqflite.dart';
import 'package:personal_finance_calculator/core/services/sqflite_manager.dart';
import 'package:personal_finance_calculator/core/services/i_database_manager.dart';

part 'database_providers.g.dart'; // Generated by riverpod_generator

@Riverpod(keepAlive: true) // Keeps the manager instance alive for the app's lifetime
IDatabaseManager databaseManager(DatabaseManagerRef ref) {
  return SqfLiteManager(); // Returns the singleton instance
}

@Riverpod(keepAlive: true) // Provides direct access to the `Database` object
Future<Database> databaseInstance(DatabaseInstanceRef ref) async {
  final manager = ref.read(databaseManagerProvider); // Depends on the manager provider
  return manager.database; // Awaits the database initialization
}
```

-----
